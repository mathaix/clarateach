services:
  workspace:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: clarateach-workspace
    hostname: workspace
    stdin_open: true
    tty: true
    volumes:
      # Persist workspace files
      - workspace-data:/workspace
    ports:
      # Workspace server
      - "3000:3000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - WORKSPACE_DIR=/workspace
      - TERM=xterm-256color
      - PORT=3000
    networks:
      - clarateach-net
    # Start the workspace server
    command: node /home/learner/server/dist/index.js

  # neko browser preview
  # Note: neko only supports amd64, uses QEMU emulation on ARM Macs
  neko:
    image: m1k1o/neko:firefox
    platform: linux/amd64
    container_name: clarateach-neko
    shm_size: "2gb"
    environment:
      NEKO_SCREEN: "1280x720@30"
      NEKO_PASSWORD: "neko"
      NEKO_PASSWORD_ADMIN: "admin"
      NEKO_EPR: "52000-52100"
      NEKO_ICELITE: "true"
      # Control settings
      NEKO_CONTROL_PROTECTION: "false"
      NEKO_IMPLICIT_CONTROL: "true"
    ports:
      # neko web UI
      - "8080:8080"
      # WebRTC UDP ports
      - "52000-52100:52000-52100/udp"
    networks:
      - clarateach-net
    cap_add:
      - SYS_ADMIN

volumes:
  workspace-data:
    driver: local

networks:
  clarateach-net:
    driver: bridge
